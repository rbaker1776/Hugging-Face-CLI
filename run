#!/bin/bash

# API run script
# Usage: ./run [install|URL_FILE|test]

set -e

if [ $# -eq 0 ]; then
    echo "Usage: ./run [install|URL_FILE|test]" >&2
    exit 1
fi

ARG="$1"

case "$ARG" in
    "install")
        echo "Installing dependencies..."
        
        pip install -r requirements.txt

        echo "Dependencies installed successfully."
        exit 0
        ;;
    "test")
        #echo "Running test suite..."
        
        output=$(python3 -m pytest --cov=src 2>&1)
        exit_code=$?

        passed=$(echo "$output" | grep -o '[0-9]* passed' | grep -o '[0-9]*' | head -1)
        passed=${passed:-0}
        failed=$(echo "$output" | grep -o '[0-9]* failed' | grep -o '[0-9]*' | head -1)
        failed=${failed:-0}

        total=$((passed + failed))
        coverage=$(echo "$output" | grep "TOTAL" | awk '{print $NF}' | sed 's/%//')
        coverage=${coverage:-0}

        echo "$passed/$total test cases passed. $coverage% line coverage achieved."
        exit $exit_code
        ;;
    *)
        URL_FILE="$ARG"
        echo "Processing URL file: $URL_FILE"

        if [ ! -f "$URL_FILE" ]; then
            echo "Error: File '$URL_FILE' not found"
            exit 1
        fi

        python -m src.main "$URL_FILE"
        exit 0;
        ;;
esac
